# Kenshi-Online (KenshiMP) — Руководство пользователя

## Что такое Kenshi-Online?

Kenshi-Online — это мультиплеерный мод, позволяющий до 16 игрокам играть в Kenshi вместе. Вы можете исследовать мир, строить базы, сражаться с врагами и взаимодействовать друг с другом в реальном времени.

### Возможности
- До 16 игроков на одном сервере
- Синхронизация позиций персонажей в реальном времени с плавной интерполяцией
- Мультиплеерный бой с серверной авторитетной системой урона
- Внутриигровой чат
- ImGui оверлей (подключение, список игроков, чат, отладочная информация)
- Выделенный сервер с консольными командами
- Сохранение состояния мира (сохранение/загрузка между перезапусками сервера)
- Зонная система интереса (синхронизируются только ближайшие объекты)

---

## Требования

- Kenshi версии 1.0.59 или новее (протестировано на v1.0.68)
- Windows 10/11 64-бит
- Файлы мода:
  - `KenshiMP.Core.dll` — клиентский плагин
  - `KenshiMP.Injector.exe` — инжектор плагина в Kenshi
  - `KenshiMP.Server.exe` — выделенный сервер (нужен только для хостинга)

---

## Как играть (Клиент)

### Шаг 1: Запустите Kenshi
Запустите Kenshi обычным способом через Steam или GOG. Загрузите сохранение или начните новую игру.

### Шаг 2: Инжекция мода
Запустите `KenshiMP.Injector.exe`. Он:
- Найдёт запущенный процесс Kenshi
- Инжектирует `KenshiMP.Core.dll` в него
- Мод инициализируется автоматически (хуки, оверлей, сеть)

В правом верхнем углу экрана должна появиться надпись «KENSHI-ONLINE | Offline».

### Шаг 3: Подключение к серверу
При загрузке мода автоматически появляется **Главное Меню** с такими опциями:
- **Quick Connect** — ввести IP и порт сервера, затем подключиться
- **Server Browser** — просмотреть доступные серверы или ввести прямой IP
- **Settings** — настроить имя игрока, сервер по умолчанию, автоподключение

Введите имя игрока, выберите сервер и нажмите Connect. После подключения меню закроется, и на экране появится игровой HUD с количеством игроков и пингом.

### Управление
| Клавиша | Действие |
|---------|----------|
| F1 | Открыть/закрыть Главное Меню (или окно подключения при подключении) |
| Tab | Открыть/закрыть список игроков |
| Enter | Открыть/закрыть чат |
| ` (обратный апостроф) | Открыть/закрыть отладочный оверлей |
| Escape | Назад / Закрыть окна |

### Чат
Нажмите **Enter**, чтобы открыть окно чата. Введите сообщение и нажмите Enter или кнопку Send. Системные сообщения (подключение игроков, выход, кик) отображаются автоматически.

---

## Как запустить сервер

### Быстрый старт (локально)
1. Запустите `KenshiMP.Server.exe`
2. Файл конфигурации `server.json` создаётся автоматически при первом запуске
3. Сервер начинает прослушивание на порту **27800**
4. Игроки подключаются, используя ваш IP-адрес

### Настройка сервера (server.json)
```json
{
  "serverName": "Мой сервер Kenshi",
  "port": 27800,
  "maxPlayers": 16,
  "tickRate": 20,
  "gameSpeed": 1,
  "pvpEnabled": true,
  "savePath": "world.kmpsave"
}
```

| Параметр | Описание |
|----------|----------|
| serverName | Отображаемое имя сервера |
| port | UDP-порт для прослушивания (по умолчанию: 27800) |
| maxPlayers | Максимальное количество игроков (1-16) |
| tickRate | Частота обновления сервера в Гц (по умолчанию: 20) |
| gameSpeed | Множитель игрового времени (1 = обычная скорость) |
| pvpEnabled | Разрешить бой между игроками |
| savePath | Путь к файлу сохранения мира |

Можно указать свой путь к конфигу: `KenshiMP.Server.exe путь/к/config.json`

### Консольные команды сервера
| Команда | Описание |
|---------|----------|
| help | Показать список команд |
| status | Показать статус сервера (игроки, объекты, тик, аптайм) |
| players | Список подключённых игроков с пингом и зоной |
| kick \<id\> | Кикнуть игрока по его ID |
| say \<сообщение\> | Отправить системное сообщение всем игрокам |
| save | Сохранить текущее состояние мира на диск |
| stop | Сохранить мир и выключить сервер |

### Хостинг на VPS / выделенном сервере

1. **Скопируйте файлы** на сервер:
   - `KenshiMP.Server.exe`
   - `server.json` (опционально, создаётся автоматически)

2. **Откройте порт** UDP 27800 в файрволе:
   ```
   # Windows
   netsh advfirewall firewall add rule name="KenshiMP" dir=in action=allow protocol=UDP localport=27800

   # Linux (при использовании Wine)
   sudo ufw allow 27800/udp
   ```

3. **Отредактируйте server.json** с нужными настройками

4. **Запустите сервер**:
   ```
   KenshiMP.Server.exe
   ```

5. Игроки подключаются, используя публичный IP VPS и порт 27800

### Сохранение мира
- Сервер автоматически сохраняет мир при выключении (команда `stop` или Ctrl+C)
- Используйте команду `save` для ручного сохранения в любой момент
- При запуске сервер загружает предыдущее состояние мира, если файл сохранения существует
- Файл сохранения содержит позиции, повороты, здоровье, фракции и информацию о шаблонах всех объектов

---

## Как это работает (Техническое описание)

### Архитектура
```
[Клиент Kenshi 1]  <--ENet UDP-->  [Выделенный сервер]  <--ENet UDP-->  [Клиент Kenshi 2]
       |                                    |                                    |
 KenshiMP.Core.dll              KenshiMP.Server.exe               KenshiMP.Core.dll
 (хуки + оверлей)               (авторитет + ретрансляция)         (хуки + оверлей)
```

### Процесс подключения
1. Клиент вызывает `ConnectAsync()` — инициирует ENet-соединение (неблокирующее)
2. При подключении клиент отправляет `C2S_Handshake` с именем игрока и версией протокола
3. Сервер отвечает `S2C_HandshakeAck` (ID игрока, время суток, количество игроков)
4. Сервер отправляет существующих игроков через сообщения `S2C_PlayerJoined`
5. Сервер отправляет снимок мира (все объекты) через сообщения `S2C_EntitySpawn`

### Синхронизация позиций
- Каждый клиент считывает позиции локальных персонажей из памяти игры каждый тик
- Позиции группируются в пакеты `C2S_PositionUpdate` (отправляются unreliable для скорости)
- Сервер сохраняет позиции и пересылает их другим клиентам (с фильтрацией по зонам)
- Принимающие клиенты интерполируют позиции с буфером задержки 100мс для плавности
- Интерполированные позиции записываются в игровых персонажей через физический движок
- Скорость движения вычисляется из дельты позиции (надёжно работает без знания внутренних смещений)

### Бой
- Когда локальный персонаж атакует, клиент отправляет `C2S_AttackIntent`
- Сервер рассчитывает бой (случайная часть тела, расчёт урона, шанс блока)
- Сервер рассылает `S2C_CombatHit` с значениями урона и результирующим здоровьем
- Клиенты применяют урон к своим локальным игровым объектам
- Смерть/нокаут рассылается отдельно при достижении порогов здоровья

### Создание объектов
- Когда игра создаёт нового персонажа, хук отправляет `C2S_EntitySpawnReq`
- Сервер назначает сетевой ID и рассылает `S2C_EntitySpawn` всем клиентам
- Принимающие клиенты используют собственную фабричную функцию игры для создания реального персонажа
- SpawnManager захватывает фабрику персонажей игры при первом срабатывании хука

---

## Устранение неполадок

| Проблема | Решение |
|----------|---------|
| Оверлей не появляется | Убедитесь, что инжектор запущен после полной загрузки Kenshi |
| «Connection failed» | Проверьте IP/порт сервера, убедитесь что UDP 27800 открыт |
| Персонажи не двигаются | Откройте отладочный оверлей (клавиша `) — проверьте, что SetPosition = «resolved» |
| Высокий пинг / лаг | Сервер должен быть географически близко к игрокам; проверьте сеть |
| Сервер не запускается | Проверьте, не занят ли порт 27800; попробуйте другой порт |
| Краш игры при инжекции | Проверьте KenshiOnline.log для подробностей; возможен сбой сканера паттернов |

### Файлы логов
- **Клиент**: `KenshiOnline.log` (в директории Kenshi)
- **Сервер**: `KenshiOnline_Server.log` (в директории сервера)

---

## Известные ограничения (v0.1.0)

- **Синхронизация экипировки** пока не работает (требуется дополнительный реверс-инжиниринг структуры памяти экипировки)
- **Строительство** отслеживается на сервере, но визуально не реплицируется для других игроков
- **Браузер серверов** показывает только локальный и последний использованный сервер; нет мастер-сервера или обнаружения по LAN
- **Синхронизация NPC** односторонняя (ваши NPC видны другим, но ИИ NPC работает независимо у каждого клиента)
- **Сохранения игры** не синхронизируются — каждый игрок использует своё сохранение Kenshi
